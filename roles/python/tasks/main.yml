---
- name: Make sure pyenv is installed
  community.general.homebrew:
    name: pyenv
    state: present

- name: Get latest available stable Python version
  ansible.builtin.shell: |
    set -o pipefail
    pyenv install -l \
      | grep -E '^\s*[0-9]+\.[0-9]+\.[0-9]+$' \
      | tail -1 \
      | tr -d '[:space:]'
  register: python_latest_version
  changed_when: false

- name: Get current global Python version
  ansible.builtin.command: pyenv global
  register: python_current_version
  changed_when: false
  failed_when: false

- name: Install latest Python version via pyenv
  ansible.builtin.command:
    pyenv install "{{ python_latest_version.stdout }}" --skip-existing
  when: python_current_version.stdout != python_latest_version.stdout
  changed_when: true
  register: python_install

- name: Set global Python version to latest
  ansible.builtin.command: pyenv global "{{ python_latest_version.stdout }}"
  when: python_current_version.stdout != python_latest_version.stdout
  changed_when: true
  notify: Rehash pyenv shims
