---
name: CI
'on':
  pull_request:
    branches: [master]
  push:
    branches: [master]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Check out the codebase.
        uses: actions/checkout@v5
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Lint YAML files
        uses: ibiqlik/action-yamllint@master
      - name: Run Ansible Lint
        uses: ansible/ansible-lint@main
        with:
          setup_python: "false"
      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          ignore_paths: .ansible

  integration_playbook:
    name: Integration tests for ansible playbook
    runs-on: ${{ matrix.os }}
    needs: lint
    strategy:
      matrix:
        os:
          - macos-latest
          - macos-13
    steps:
      - name: Check out the codebase
        uses: actions/checkout@v5

      - name: Uninstall CI runners' built-in cask apps
        run: brew uninstall --cask --force $(brew list --cask)

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install test dependencies
        run: pip install -r requirements.txt

      - name: Run the tests
        run: molecule test

  integration_setup_script:
    name: Integration tests for setup script
    runs-on: macos-latest
    needs: lint
    steps:
      - name: Check out the codebase
        uses: actions/checkout@v5

      - name: Uninstall CI runners' built-in cask apps
        run: brew uninstall --cask --force $(brew list --cask)

      - name: Uninstall CI runners' built-in Homebrew.
        run: tests/uninstall_homebrew.sh

      - name: Run the setup script
        run: ./setup.sh
